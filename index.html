<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fitness Track</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');
  * {
    box-sizing: border-box;
  }
  body {
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #74ebd5 0%, #ACB6E5 100%);
    margin: 0;
    min-height: 100vh;
    color: #2c3e50;
  }
  nav {
    background: #34495e;
    padding: 1rem 2rem;
    color: #ecf0f1;
    font-weight: 600;
    font-size: 1.5rem;
    text-align: center;
    box-shadow: 0 3px 10px rgba(0,0,0,0.3);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  main {
    max-width: 900px;
    margin: 2rem auto 4rem;
    padding: 0 1rem;
    background: rgba(255,255,255,0.95);
    border-radius: 15px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
  }

  h1 {
    font-weight: 700;
    text-align: center;
    color: #34495e;
    margin-bottom: 1.8rem;
  }

  .flex {
    display: flex;
    gap: 2rem;
    flex-wrap: wrap;
    justify-content: center;
  }

  form {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(52, 73, 94, 0.1);
    padding: 1.8rem 2rem;
    flex: 1 1 380px;
    min-width: 300px;
    transition: box-shadow 0.3s ease;
  }
  form:hover {
    box-shadow: 0 8px 30px rgba(52, 73, 94, 0.2);
  }
  form h2 {
    font-weight: 700;
    margin-bottom: 1rem;
    color: #2c3e50;
    border-bottom: 2px solid #74ebd5;
    padding-bottom: 0.4rem;
  }

  label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.3rem;
    color: #34495e;
  }

  input[type="text"],
  input[type="date"],
  input[type="number"],
  select {
    width: 100%;
    padding: 0.55rem 0.75rem;
    margin-bottom: 1.2rem;
    border: 2px solid #bdc3c7;
    border-radius: 10px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
  }
  input[type="text"]:focus,
  input[type="date"]:focus,
  input[type="number"]:focus,
  select:focus {
    border-color: #74ebd5;
    outline: none;
    box-shadow: 0 0 8px #74ebd5;
  }

  button {
    background: #34495e;
    color: white;
    font-weight: 700;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-size: 1.1rem;
    width: 100%;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background: #2c3e50;
  }

  /* –°–ø–∏—Å—ä–∫ —Å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è */
  #workoutsListContainer {
    margin-top: 3rem;
  }

  .workout-card {
    background: #ecf0f1;
    border-radius: 15px;
    margin-bottom: 1.8rem;
    padding: 1.5rem 2rem;
    box-shadow: 0 6px 20px rgba(0,0,0,0.07);
    position: relative;
    transition: transform 0.2s ease;
  }
  .workout-card:hover {
    transform: translateY(-3px);
  }

  .workout-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    flex-wrap: wrap;
    gap: 1rem;
  }
  .workout-title {
    font-size: 1.2rem;
    font-weight: 700;
    color: #2c3e50;
  }
  .workout-info {
    font-weight: 500;
    color: #34495e;
    font-size: 0.95rem;
  }
  .btn-delete {
    background: #e74c3c;
    border: none;
    color: white;
    padding: 0.5rem 1.1rem;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 700;
    font-size: 0.95rem;
    box-shadow: 0 4px 12px rgba(231,76,60,0.4);
    transition: background-color 0.3s ease;
  }
  .btn-delete:hover {
    background: #c0392b;
  }

  ul.exercises-list {
    list-style: none;
    padding-left: 0;
    margin: 0;
  }
  ul.exercises-list li {
    background: white;
    margin-bottom: 0.8rem;
    border-radius: 8px;
    padding: 0.9rem 1.2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 1px 5px rgba(0,0,0,0.05);
    font-weight: 600;
    font-size: 1rem;
    color: #2c3e50;
  }
  .btn-delete-ex {
    background: #e67e22;
    border: none;
    color: white;
    padding: 0.3rem 0.7rem;
    border-radius: 7px;
    cursor: pointer;
    font-weight: 700;
    font-size: 0.9rem;
    box-shadow: 0 3px 10px rgba(230,126,34,0.4);
    transition: background-color 0.3s ease;
  }
  .btn-delete-ex:hover {
    background: #d35400;
  }

  /* –ò–∑—á–∏—Å—Ç–∏ –≤—Å–∏—á–∫–∏ */
  #clearAllBtn {
    display: block;
    margin: 2rem auto 3rem;
    background: #e67e22;
    padding: 0.85rem 2rem;
    border-radius: 14px;
    font-weight: 700;
    color: white;
    border: none;
    cursor: pointer;
    font-size: 1.15rem;
    box-shadow: 0 5px 15px rgba(230,126,34,0.5);
    transition: background-color 0.3s ease;
    max-width: 300px;
  }
  #clearAllBtn:hover {
    background: #d35400;
  }

  /* –ú–æ–±–∏–ª–Ω–∞ –≤–µ—Ä—Å–∏—è */
  @media (max-width: 620px) {
    .flex {
      flex-direction: column;
    }
    form {
      min-width: 100%;
    }
  }
</style>
</head>
<body>
<nav>Fitness Tracker</nav>

<main>
  <h1>Fitness Tracker</h1>

  <div class="flex">
    <form id="workoutForm">
      <h2>–î–æ–±–∞–≤–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h2>
      <label for="date">–î–∞—Ç–∞:</label>
      <input type="date" id="date" required />

      <label for="workout_type">–í–∏–¥ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞:</label>
      <input type="text" id="workout_type" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ë—è–≥–∞–Ω–µ" required />

      <label for="duration">–ü—Ä–æ–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ—Å—Ç (–º–∏–Ω):</label>
      <input type="number" id="duration" min="1" placeholder="–ú–∏–Ω—É—Ç–∏—Ç–µ" required />

      <button type="submit">–î–æ–±–∞–≤–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</button>
    </form>

    <form id="exerciseForm">
      <h2>–î–æ–±–∞–≤–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –∫—ä–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h2>
      <label for="selectWorkout">–ò–∑–±–µ—Ä–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞:</label>
      <select id="selectWorkout" required>
        <option value="" disabled selected>-- –ò–∑–±–µ—Ä–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ --</option>
      </select>

      <label for="exercise_name">–ò–º–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ:</label>
      <input type="text" id="exercise_name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–ª–µ–∫–æ–≤–µ" required />

      <label for="reps">–ë—Ä–æ–π –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è:</label>
      <input type="number" id="reps" min="1" placeholder="–ë—Ä–æ–π –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è" required />

      <label for="sets">–ë—Ä–æ–π —Å–µ—Ä–∏–∏:</label>
      <input type="number" id="sets" min="1" placeholder="–ë—Ä–æ–π —Å–µ—Ä–∏–∏" required />

      <button type="submit">–î–æ–±–∞–≤–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>
    </form>
  </div>

  <button id="clearAllBtn" title="–ò–∑—á–∏—Å—Ç–∏ –≤—Å–∏—á–∫–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è">–ò–∑—á–∏—Å—Ç–∏ –≤—Å–∏—á–∫–∏ –¥–∞–Ω–Ω–∏</button>

  <section id="workoutsListContainer" aria-live="polite" aria-label="–°–ø–∏—Å—ä–∫ —Å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è">
    <!-- –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏—Ç–µ –∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è—Ç–∞ —â–µ —Å–µ –ø–æ–∫–∞–∂–∞—Ç —Ç—É–∫ -->
  </section>
</main>

<script>
  // –£–Ω–∏–∫–∞–ª–µ–Ω ID –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
  function generateId() {
    return Date.now() + Math.floor(Math.random() * 1000);
  }

  // –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
  function getWorkouts() {
    return JSON.parse(localStorage.getItem('workouts') || '[]');
  }

  // –ó–∞–ø–∏—Å –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
  function saveWorkouts(workouts) {
    localStorage.setItem('workouts', JSON.stringify(workouts));
  }

  // –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–Ω–µ –Ω–∞ dropdown –º–µ–Ω—é—Ç–æ —Å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏—Ç–µ
  function updateWorkoutSelect() {
    const workouts = getWorkouts();
    const select = document.getElementById('selectWorkout');
    select.innerHTML = '<option value="" disabled selected>-- –ò–∑–±–µ—Ä–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ --</option>';
    if (workouts.length === 0) {
      const option = document.createElement('option');
      option.text = '–ù—è–º–∞ –¥–æ–±–∞–≤–µ–Ω–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏';
      option.disabled = true;
      select.add(option);
      select.disabled = true;
    } else {
      workouts.forEach(w => {
        const option = document.createElement('option');
        option.value = w.id;
        option.text = `${w.date} | ${w.workout_type} (${w.duration_minutes} –º–∏–Ω)`;
        select.add(option);
      });
      select.disabled = false;
    }
  }

  // –ü–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ –≤—Å–∏—á–∫–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
  function loadWorkouts() {
    const container = document.getElementById('workoutsListContainer');
    const workouts = getWorkouts();
    container.innerHTML = '';

    if (workouts.length === 0) {
      container.innerHTML = `<p style="text-align:center; font-style:italic; color:#7f8c8d; font-size:1.1rem;">–í—Å–µ –æ—â–µ –Ω—è–º–∞ –¥–æ–±–∞–≤–µ–Ω–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.</p>`;
      updateWorkoutSelect();
      return;
    }

    workouts.forEach(w => {
      const card = document.createElement('article');
      card.className = 'workout-card';

      const header = document.createElement('div');
      header.className = 'workout-header';

      const title = document.createElement('div');
      title.className = 'workout-title';
      title.textContent = `${w.date} | ${w.workout_type}`;

      const info = document.createElement('div');
      info.className = 'workout-info';
      info.textContent = `–ü—Ä–æ–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ—Å—Ç: ${w.duration_minutes} –º–∏–Ω`;

      const delBtn = document.createElement('button');
      delBtn.className = 'btn-delete';
      delBtn.textContent = '–ò–∑—Ç—Ä–∏–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞';
      delBtn.title = '–ò–∑—Ç—Ä–∏–π —Ç–∞–∑–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞';
      delBtn.addEventListener('click', () => {
        if(confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—Ç—Ä–∏–µ—Ç–µ —Ç–∞–∑–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞?')) {
          deleteWorkout(w.id);
        }
      });

      header.append(title, info, delBtn);
      card.appendChild(header);

      // –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
      const exercisesList = document.createElement('ul');
      exercisesList.className = 'exercises-list';

      if (!w.exercises || w.exercises.length === 0) {
        const noEx = document.createElement('li');
        noEx.style.fontStyle = 'italic';
        noEx.style.color = '#95a5a6';
        noEx.textContent = '–ù—è–º–∞ –¥–æ–±–∞–≤–µ–Ω–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è.';
        exercisesList.appendChild(noEx);
      } else {
        w.exercises.forEach(ex => {
          const li = document.createElement('li');
          li.textContent = `${ex.name} ‚Äî ${ex.reps} –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è x ${ex.sets} —Å–µ—Ä–∏–∏`;

          const delExBtn = document.createElement('button');
          delExBtn.className = 'btn-delete-ex';
          delExBtn.title = '–ò–∑—Ç—Ä–∏–π —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ';
          delExBtn.textContent = '‚úñ';
          delExBtn.addEventListener('click', () => {
            if(confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—Ç—Ä–∏–µ—Ç–µ —Ç–æ–≤–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ?')) {
              deleteExercise(w.id, ex.id);
            }
          });

          li.appendChild(delExBtn);
          exercisesList.appendChild(li);
        });
      }
      card.appendChild(exercisesList);

      container.appendChild(card);
    });

    updateWorkoutSelect();
  }

  // –ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞
  function deleteWorkout(id) {
    let workouts = getWorkouts();
    workouts = workouts.filter(w => w.id !== id);
    saveWorkouts(workouts);
    loadWorkouts();
  }

  // –ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ
  function deleteExercise(workoutId, exerciseId) {
    let workouts = getWorkouts();
    const workout = workouts.find(w => w.id === workoutId);
    if (!workout) return;

    workout.exercises = workout.exercises.filter(ex => ex.id !== exerciseId);
    saveWorkouts(workouts);
    loadWorkouts();
  }

  // –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞
  document.getElementById('workoutForm').addEventListener('submit', e => {
    e.preventDefault();
    const date = e.target.date.value;
    const workout_type = e.target.workout_type.value.trim();
    const duration = parseInt(e.target.duration.value, 10);

    if (!date || !workout_type || !duration || duration < 1) {
      alert('–ú–æ–ª—è, –ø–æ–ø—ä–ª–Ω–µ—Ç–µ –≤—Å–∏—á–∫–∏ –ø–æ–ª–µ—Ç–∞ –ø—Ä–∞–≤–∏–ª–Ω–æ!');
      return;
    }

    const workouts = getWorkouts();
    const newWorkout = {
      id: generateId(),
      date,
      workout_type,
      duration_minutes: duration,
      exercises: []
    };

    workouts.push(newWorkout);
    saveWorkouts(workouts);

    alert('–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ç–∞ –µ –¥–æ–±–∞–≤–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!');
    e.target.reset();
    loadWorkouts();
  });

  // –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ
  document.getElementById('exerciseForm').addEventListener('submit', e => {
    e.preventDefault();
    const workoutId = parseInt(e.target.selectWorkout.value, 10);
    const exercise_name = e.target.exercise_name.value.trim();
    const reps = parseInt(e.target.reps.value, 10);
    const sets = parseInt(e.target.sets.value, 10);

    if (!workoutId || !exercise_name || !reps || !sets || reps < 1 || sets < 1) {
      alert('–ú–æ–ª—è, –ø–æ–ø—ä–ª–Ω–µ—Ç–µ –≤—Å–∏—á–∫–∏ –ø–æ–ª–µ—Ç–∞ –ø—Ä–∞–≤–∏–ª–Ω–æ!');
      return;
    }

    const workouts = getWorkouts();
    const workout = workouts.find(w => w.id === workoutId);

    if (!workout) {
      alert('–ù–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å —Ç–æ–∑–∏ –∏–∑–±–æ—Ä!');
      return;
    }

    const newExercise = {
      id: generateId(),
      name: exercise_name,
      reps,
      sets
    };

    workout.exercises.push(newExercise);
    saveWorkouts(workouts);

    alert('–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ—Ç–æ –µ –¥–æ–±–∞–≤–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!');
    e.target.reset();
    loadWorkouts();
  });

  // –ò–∑—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ –≤—Å–∏—á–∫–∏ –¥–∞–Ω–Ω–∏
  document.getElementById('clearAllBtn').addEventListener('click', () => {
    if (confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—Ç—Ä–∏–µ—Ç–µ –≤—Å–∏—á–∫–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è?')) {
      localStorage.removeItem('workouts');
      loadWorkouts();
      alert('–í—Å–∏—á–∫–∏ –¥–∞–Ω–Ω–∏ —Å–∞ –∏–∑—á–∏—Å—Ç–µ–Ω–∏.');
    }
  });

  // –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –∑–∞—Ä–µ–∂–¥–∞–º–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏—Ç–µ
  loadWorkouts();

  // --- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ---
  function showStats() {
    const workouts = getWorkouts();
    let totalMinutes = 0;
    let exerciseCount = 0;
    const exerciseMap = {};
    const now = new Date();
    const weekStart = new Date(now);
    weekStart.setDate(now.getDate() - now.getDay());
    weekStart.setHours(0,0,0,0);

    workouts.forEach(w => {
      const wDate = new Date(w.date);
      if (wDate >= weekStart && wDate <= now) {
        totalMinutes += w.duration_minutes;
      }
      if (w.exercises) {
        exerciseCount += w.exercises.length;
        w.exercises.forEach(ex => {
          exerciseMap[ex.name] = (exerciseMap[ex.name] || 0) + 1;
        });
      }
    });

    let mostCommon = '-';
    let max = 0;
    for (const [name, count] of Object.entries(exerciseMap)) {
      if (count > max) {
        max = count;
        mostCommon = name;
      }
    }

    document.getElementById('statsContainer').innerHTML = `
      <div style="display:flex;gap:2rem;justify-content:center;flex-wrap:wrap;">
        <div><b>–û–±—â–æ –≤—Ä–µ–º–µ —Ç–∞–∑–∏ —Å–µ–¥–º–∏—Ü–∞:</b> ${totalMinutes} –º–∏–Ω</div>
        <div><b>–û–±—â–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è:</b> ${exerciseCount}</div>
        <div><b>–ù–∞–π-—á–µ—Å—Ç–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ:</b> ${mostCommon}</div>
      </div>
    `;
  }

  // --- –ö–∞–ª–µ–Ω–¥–∞—Ä–µ–Ω –∏–∑–≥–ª–µ–¥ ---
  function showCalendar() {
    const workouts = getWorkouts();
    const calendar = document.getElementById('calendarContainer');
    calendar.innerHTML = '';
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth();

    // –°—ä–∑–¥–∞–π —Ç–∞–±–ª–∏—Ü–∞ –∑–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä–∞
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month+1, 0).getDate();
    let html = `<table style="width:100%;border-collapse:collapse;text-align:center;">
      <tr style="background:#ACB6E5;">
        <th>–ü</th><th>–í</th><th>–°</th><th>–ß</th><th>–ü</th><th>–°–±</th><th>–ù–¥</th>
      </tr><tr>
    `;
    let day = 1;
    for (let i = 0; i < 7; i++) {
      if (i < (firstDay === 0 ? 6 : firstDay-1)) html += '<td></td>';
      else {
        html += renderDayCell(day, month, year, workouts);
        day++;
      }
    }
    html += '</tr>';
    while (day <= daysInMonth) {
      html += '<tr>';
      for (let i = 0; i < 7; i++) {
        if (day > daysInMonth) html += '<td></td>';
        else {
          html += renderDayCell(day, month, year, workouts);
          day++;
        }
      }
      html += '</tr>';
    }
    html += '</table>';
    calendar.innerHTML = html;
  }

  function renderDayCell(day, month, year, workouts) {
    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const ws = workouts.filter(w => w.date === dateStr);
    let cell = `<td style="border:1px solid #bdc3c7;min-width:60px;vertical-align:top;padding:2px 4px;${ws.length ? 'background:#74ebd5;' : ''}">`;
    cell += `<div style="font-weight:bold;">${day}</div>`;
    ws.forEach(w => {
      cell += `<div style="font-size:0.85em;background:#fff;border-radius:6px;margin:2px 0;padding:2px 4px;">
        ${w.workout_type}
      </div>`;
    });
    cell += '</td>';
    return cell;
  }

  // --- –¢–µ–º–∏ (—Ç—ä–º–Ω–∞/—Å–≤–µ—Ç–ª–∞) ---
  function setTheme(theme) {
    document.body.dataset.theme = theme;
    localStorage.setItem('theme', theme);
    if (theme === 'dark') {
      document.body.style.background = 'linear-gradient(135deg, #232526 0%, #414345 100%)';
      document.body.style.color = '#ecf0f1';
      document.querySelector('main').style.background = 'rgba(44,62,80,0.97)';
    } else {
      document.body.style.background = 'linear-gradient(135deg, #74ebd5 0%, #ACB6E5 100%)';
      document.body.style.color = '#2c3e50';
      document.querySelector('main').style.background = 'rgba(255,255,255,0.95)';
    }
  }
  document.getElementById('themeToggleBtn').addEventListener('click', () => {
    const theme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
    setTheme(theme);
  });
  // –ü—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ
  setTheme(localStorage.getItem('theme') || 'light');

  // --- –û–±–Ω–æ–≤–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∫–∞–ª–µ–Ω–¥–∞—Ä –ø—Ä–∏ –ø—Ä–æ–º—è–Ω–∞ ---
  function updateAll() {
    loadWorkouts();
    showStats();
    showCalendar();
  }

  // --- –†–µ–¥–∞–∫—Ç–∏—Ä–∞–Ω–µ –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ ---
  function editWorkout(id) {
    const workouts = getWorkouts();
    const workout = workouts.find(w => w.id === id);
    if (!workout) return;
    // –ü–æ–∫–∞–∂–∏ –º–æ–¥–∞–ª–µ–Ω –ø—Ä–æ–∑–æ—Ä–µ—Ü –∑–∞ —Ä–µ–¥–∞–∫—Ü–∏—è (basic prompt –∑–∞ –ø—Ä–∏–º–µ—Ä)
    const newType = prompt('–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π –≤–∏–¥ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞:', workout.workout_type);
    if (newType === null) return;
    const newDuration = prompt('–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π –ø—Ä–æ–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ—Å—Ç (–º–∏–Ω):', workout.duration_minutes);
    if (newDuration === null) return;
    const newCategory = prompt('–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π –∫–∞—Ç–µ–≥–æ—Ä–∏—è:', workout.category || '');
    const newTags = prompt('–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π —Ç–∞–≥–æ–≤–µ (—Ä–∞–∑–¥–µ–ª–µ–Ω–∏ —Å—ä—Å –∑–∞–ø–µ—Ç–∞—è):', (workout.tags||[]).join(','));
    const newNotes = prompt('–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π –±–µ–ª–µ–∂–∫–∏:', workout.notes || '');
    workout.workout_type = newType.trim();
    workout.duration_minutes = parseInt(newDuration,10);
    workout.category = newCategory ? newCategory.trim() : '';
    workout.tags = newTags ? newTags.split(',').map(t=>t.trim()).filter(Boolean) : [];
    workout.notes = newNotes ? newNotes.trim() : '';
    // –ö–∞–ª–æ—Ä–∏–∏
    workout.calories = estimateCalories(workout.workout_type, workout.duration_minutes);
    saveWorkouts(workouts);
    updateAll();
  }

  // --- –†–µ–¥–∞–∫—Ç–∏—Ä–∞–Ω–µ –Ω–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ ---
  function editExercise(workoutId, exerciseId) {
    const workouts = getWorkouts();
    const workout = workouts.find(w => w.id === workoutId);
    if (!workout) return;
    const ex = workout.exercises.find(e => e.id === exerciseId);
    if (!ex) return;
    const newName = prompt('–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π –∏–º–µ –Ω–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ:', ex.name);
    if (newName === null) return;
    const newReps = prompt('–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π –±—Ä–æ–π –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è:', ex.reps);
    if (newReps === null) return;
    const newSets = prompt('–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π –±—Ä–æ–π —Å–µ—Ä–∏–∏:', ex.sets);
    if (newSets === null) return;
    ex.name = newName.trim();
    ex.reps = parseInt(newReps,10);
    ex.sets = parseInt(newSets,10);
    saveWorkouts(workouts);
    updateAll();
  }

  // --- –ö–∞–ª–æ—Ä–∏–∏ –ø–æ —Ç–∏–ø —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ (–ø—Ä–∏–º–µ—Ä–Ω–∏ —Å—Ç–æ–π–Ω–æ—Å—Ç–∏) ---
  function estimateCalories(type, minutes) {
    const map = {
      '–±—è–≥–∞–Ω–µ': 10,
      '–∫–∞—Ä–¥–∏–æ': 8,
      '–π–æ–≥–∞': 4,
      '—Å–∏–ª–∞': 7,
      '–∫–æ–ª–æ–µ–∑–¥–µ–Ω–µ': 7,
      '–ø–ª—É–≤–∞–Ω–µ': 9
    };
    let t = type.toLowerCase();
    let perMin = 6;
    for (const k in map) if (t.includes(k)) perMin = map[k];
    return perMin * minutes;
  }

  // --- –î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –Ω–æ–≤–∏ –ø–æ–ª–µ—Ç–∞ –≤—ä–≤ —Ñ–æ—Ä–º–∞—Ç–∞ –∑–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ ---
  // (–∫–∞—Ç–µ–≥–æ—Ä–∏—è, —Ç–∞–≥–æ–≤–µ, –±–µ–ª–µ–∂–∫–∏, —Å–Ω–∏–º–∫–∞)
  // –î–æ–±–∞–≤–∏ –≤ HTML:
  // <label for="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
  // <input type="text" id="category" placeholder="–Ω–∞–ø—Ä. –ö–∞—Ä–¥–∏–æ, –°–∏–ª–∞" />
  // <label for="tags">–¢–∞–≥–æ–≤–µ:</label>
  // <input type="text" id="tags" placeholder="–Ω–∞–ø—Ä. –∫—Ä–∞–∫–∞, —Å—É—Ç—Ä–∏–Ω" />
  // <label for="notes">–ë–µ–ª–µ–∂–∫–∏:</label>
  // <textarea id="notes" placeholder="–ë–µ–ª–µ–∂–∫–∏ –∫—ä–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ç–∞"></textarea>
  // <label for="photo">–°–Ω–∏–º–∫–∞:</label>
  // <input type="file" id="photo" accept="image/*" />

  // --- –ü—Ä–æ–º–µ–Ω–∏ submit –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∑–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ ---
  document.getElementById('workoutForm').addEventListener('submit', async e => {
    e.preventDefault();
    const date = e.target.date.value;
    const workout_type = e.target.workout_type.value.trim();
    const duration = parseInt(e.target.duration.value, 10);
    const category = e.target.category ? e.target.category.value.trim() : '';
    const tags = e.target.tags ? e.target.tags.value.split(',').map(t=>t.trim()).filter(Boolean) : [];
    const notes = e.target.notes ? e.target.notes.value.trim() : '';
    let photoData = '';
    if (e.target.photo && e.target.photo.files[0]) {
      photoData = await toBase64(e.target.photo.files[0]);
    }
    if (!date || !workout_type || !duration || duration < 1) {
      alert('–ú–æ–ª—è, –ø–æ–ø—ä–ª–Ω–µ—Ç–µ –≤—Å–∏—á–∫–∏ –ø–æ–ª–µ—Ç–∞ –ø—Ä–∞–≤–∏–ª–Ω–æ!');
      return;
    }
    const workouts = getWorkouts();
    const newWorkout = {
      id: generateId(),
      date,
      workout_type,
      duration_minutes: duration,
      category,
      tags,
      notes,
      photo: photoData,
      calories: estimateCalories(workout_type, duration),
      exercises: []
    };
    workouts.push(newWorkout);
    saveWorkouts(workouts);
    alert('–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ç–∞ –µ –¥–æ–±–∞–≤–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!');
    e.target.reset();
    updateAll();
  });

  // --- –ü–æ–º–æ—â–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞ —Å–Ω–∏–º–∫–∞ ---
  function toBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // --- –ï–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç ---
  document.getElementById('exportBtn').addEventListener('click', () => {
    const data = localStorage.getItem('workouts');
    const blob = new Blob([data], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'workouts.json';
    a.click();
  });
  document.getElementById('importBtn').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = evt => {
      try {
        const arr = JSON.parse(evt.target.result);
        if (Array.isArray(arr)) {
          localStorage.setItem('workouts', JSON.stringify(arr));
          updateAll();
          alert('–î–∞–Ω–Ω–∏—Ç–µ —Å–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä–∞–Ω–∏ —É—Å–ø–µ—à–Ω–æ!');
        }
      } catch {}
    };
    reader.readAsText(file);
  });

  // --- –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–∞–π loadWorkouts –¥–∞ –ø–æ–∫–∞–∑–≤–∞ –Ω–æ–≤–∏—Ç–µ –ø–æ–ª–µ—Ç–∞ –∏ –±—É—Ç–æ–Ω–∏ –∑–∞ —Ä–µ–¥–∞–∫—Ü–∏—è ---
  function loadWorkouts() {
    const container = document.getElementById('workoutsListContainer');
    const workouts = getWorkouts();
    container.innerHTML = '';

    if (workouts.length === 0) {
      container.innerHTML = `<p style="text-align:center; font-style:italic; color:#7f8c8d; font-size:1.1rem;">–í—Å–µ –æ—â–µ –Ω—è–º–∞ –¥–æ–±–∞–≤–µ–Ω–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.</p>`;
      updateWorkoutSelect();
      return;
    }

    workouts.forEach(w => {
      const card = document.createElement('article');
      card.className = 'workout-card';

      const header = document.createElement('div');
      header.className = 'workout-header';

      const title = document.createElement('div');
      title.className = 'workout-title';
      title.textContent = `${w.date} | ${w.workout_type}`;

      const info = document.createElement('div');
      info.className = 'workout-info';
      info.innerHTML = `–ü—Ä–æ–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ—Å—Ç: ${w.duration_minutes} –º–∏–Ω<br>
        –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${w.category || '-'}<br>
        –¢–∞–≥–æ–≤–µ: ${(w.tags||[]).join(', ') || '-'}<br>
        –ö–∞–ª–æ—Ä–∏–∏: ${w.calories || estimateCalories(w.workout_type, w.duration_minutes)} kcal`;

      const editBtn = document.createElement('button');
      editBtn.className = 'btn-edit';
      editBtn.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π';
      editBtn.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π —Ç–∞–∑–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞';
      editBtn.style.background = '#2980b9';
      editBtn.style.marginRight = '8px';
      editBtn.style.color = 'white';
      editBtn.style.borderRadius = '10px';
      editBtn.addEventListener('click', () => editWorkout(w.id));

      const delBtn = document.createElement('button');
      delBtn.className = 'btn-delete';
      delBtn.textContent = '–ò–∑—Ç—Ä–∏–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞';
      delBtn.title = '–ò–∑—Ç—Ä–∏–π —Ç–∞–∑–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞';
      delBtn.addEventListener('click', () => {
        if(confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—Ç—Ä–∏–µ—Ç–µ —Ç–∞–∑–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞?')) {
          deleteWorkout(w.id);
        }
      });

      header.append(title, info, editBtn, delBtn);
      card.appendChild(header);

      // –ë–µ–ª–µ–∂–∫–∏
      if (w.notes) {
        const notesDiv = document.createElement('div');
        notesDiv.style.fontStyle = 'italic';
        notesDiv.style.marginBottom = '0.5rem';
        notesDiv.textContent = '–ë–µ–ª–µ–∂–∫–∏: ' + w.notes;
        card.appendChild(notesDiv);
      }
      // –°–Ω–∏–º–∫–∞
      if (w.photo) {
        const img = document.createElement('img');
        img.src = w.photo;
        img.alt = '–°–Ω–∏–º–∫–∞ –∫—ä–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞';
        img.style.maxWidth = '120px';
        img.style.display = 'block';
        img.style.marginBottom = '0.5rem';
        card.appendChild(img);
      }

      // –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
      const exercisesList = document.createElement('ul');
      exercisesList.className = 'exercises-list';

      if (!w.exercises || w.exercises.length === 0) {
        const noEx = document.createElement('li');
        noEx.style.fontStyle = 'italic';
        noEx.style.color = '#95a5a6';
        noEx.textContent = '–ù—è–º–∞ –¥–æ–±–∞–≤–µ–Ω–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è.';
        exercisesList.appendChild(noEx);
      } else {
        w.exercises.forEach(ex => {
          const li = document.createElement('li');
          li.textContent = `${ex.name} ‚Äî ${ex.reps} –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è x ${ex.sets} —Å–µ—Ä–∏–∏`;

          const editExBtn = document.createElement('button');
          editExBtn.className = 'btn-edit-ex';
          editExBtn.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ';
          editExBtn.textContent = '‚úé';
          editExBtn.style.background = '#16a085';
          editExBtn.style.color = 'white';
          editExBtn.style.marginRight = '6px';
          editExBtn.style.borderRadius = '7px';
          editExBtn.addEventListener('click', () => editExercise(w.id, ex.id));

          const delExBtn = document.createElement('button');
          delExBtn.className = 'btn-delete-ex';
          delExBtn.title = '–ò–∑—Ç—Ä–∏–π —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ';
          delExBtn.textContent = '‚úñ';
          delExBtn.addEventListener('click', () => {
            if(confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—Ç—Ä–∏–µ—Ç–µ —Ç–æ–≤–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ?')) {
              deleteExercise(w.id, ex.id);
            }
          });

          li.appendChild(editExBtn);
          li.appendChild(delExBtn);
          exercisesList.appendChild(li);
        });
      }
      card.appendChild(exercisesList);

      container.appendChild(card);
    });

    updateWorkoutSelect();
  }

  // --- –ü–ª–∞–Ω–∏—Ä–∞–Ω–µ –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (basic) ---
  // –î–æ–±–∞–≤–∏ –≤ HTML: <button id="planBtn">–ü–ª–∞–Ω–∏—Ä–∞–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</button>
  document.getElementById('planBtn').addEventListener('click', () => {
    const date = prompt('–í—ä–≤–µ–¥–∏ –¥–∞—Ç–∞ –∑–∞ –ø–ª–∞–Ω–∏—Ä–∞–Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ (YYYY-MM-DD):');
    if (!date) return;
    const type = prompt('–í–∏–¥ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞:');
    if (!type) return;
    const duration = prompt('–ü—Ä–æ–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ—Å—Ç (–º–∏–Ω):');
    if (!duration) return;
    const workouts = getWorkouts();
    workouts.push({
      id: generateId(),
      date,
      workout_type: type,
      duration_minutes: parseInt(duration,10),
      planned: true,
      exercises: []
    });
    saveWorkouts(workouts);
    updateAll();
    alert('–ü–ª–∞–Ω–∏—Ä–∞–Ω–∞—Ç–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –µ –¥–æ–±–∞–≤–µ–Ω–∞!');
  });

  // --- –ù–∞–ø–æ–º–Ω—è–Ω–∏—è (basic alert) ---
  setInterval(() => {
    const workouts = getWorkouts();
    const today = new Date().toISOString().slice(0,10);
    workouts.forEach(w => {
      if (w.planned && w.date === today && !w.notified) {
        alert('–î–Ω–µ—Å –∏–º–∞—Ç–µ –ø–ª–∞–Ω–∏—Ä–∞–Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞: ' + w.workout_type);
        w.notified = true;
        saveWorkouts(workouts);
      }
    });
  }, 60000);

  // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
  updateAll();

  // --- –ì—Ä–∞—Ñ–∏–∫–∏ –∏ –¥–∏–∞–≥—Ä–∞–º–∏ (Chart.js) ---
  // –î–æ–±–∞–≤–∏ –≤ HTML: <canvas id="progressChart" style="max-width:600px;margin:2rem auto;display:block;"></canvas>
  // –í–º—ä–∫–Ω–∏ –∫–∞–Ω–≤–∞—Å–∞ –ø—Ä–µ–¥–∏ <section id="workoutsListContainer">
  (function insertChartCanvas() {
    const main = document.querySelector('main');
    if (!document.getElementById('progressChart')) {
      const canvas = document.createElement('canvas');
      canvas.id = 'progressChart';
      canvas.style.maxWidth = '600px';
      canvas.style.margin = '2rem auto';
      canvas.style.display = 'block';
      main.insertBefore(canvas, document.getElementById('workoutsListContainer'));
    }
  })();
  // –ó–∞—Ä–µ–¥–∏ Chart.js
  if (!window.Chart) {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
    script.onload = drawProgressChart;
    document.head.appendChild(script);
  } else {
    drawProgressChart();
  }
  function drawProgressChart() {
    const ctx = document.getElementById('progressChart').getContext('2d');
    const workouts = getWorkouts().filter(w => !w.planned);
    // –ì—Ä—É–ø–∏—Ä–∞–π –ø–æ –¥–∞—Ç–∞, —Å—É–º–∏—Ä–∞j –º–∏–Ω—É—Ç–∏ –∏ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
    const byDate = {};
    workouts.forEach(w => {
      if (!byDate[w.date]) byDate[w.date] = {minutes:0, reps:0};
      byDate[w.date].minutes += w.duration_minutes;
      if (w.exercises) w.exercises.forEach(ex => byDate[w.date].reps += (ex.reps*ex.sets));
    });
    const labels = Object.keys(byDate).sort();
    const minutes = labels.map(d => byDate[d].minutes);
    const reps = labels.map(d => byDate[d].reps);
    if (window.progressChart) window.progressChart.destroy();
    window.progressChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {label:'–ú–∏–Ω—É—Ç–Ω–∞ –∏–∑–¥—ä—Ä–∂–ª–∏–≤–æ—Å—Ç', data:minutes, borderColor:'#2980b9', backgroundColor:'rgba(41,128,185,0.1)', yAxisID:'y'},
          {label:'–û–±—â–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è', data:reps, borderColor:'#e67e22', backgroundColor:'rgba(230,126,34,0.1)', yAxisID:'y1'}
        ]
      },
      options: {
        responsive:true,
        plugins:{legend:{position:'top'}},
        scales:{
          y:{type:'linear', position:'left', title:{display:true,text:'–ú–∏–Ω—É—Ç–∏'}},
          y1:{type:'linear', position:'right', title:{display:true,text:'–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è'}, grid:{drawOnChartArea:false}}
        }
      }
    });
  }
  // –û–±–Ω–æ–≤–∏ –≥—Ä–∞—Ñ–∏–∫–∞—Ç–∞ –ø—Ä–∏ –ø—Ä–æ–º—è–Ω–∞
  const origUpdateAll = updateAll;
  window.updateAll = function() {
    origUpdateAll();
    if (window.Chart) drawProgressChart();
  };

  // --- –ü–ª–∞–Ω–æ–≤–µ –∏ –ø—Ä–æ–≥—Ä–∞–º–∏ ---
  // –î–æ–±–∞–≤–∏ –≤ HTML: <button id="planProgramBtn">–°—ä–∑–¥–∞–π –ø—Ä–æ–≥—Ä–∞–º–∞</button> <select id="programSelect"></select>
  (function insertProgramUI() {
    const main = document.querySelector('main');
    if (!document.getElementById('planProgramBtn')) {
      const btn = document.createElement('button');
      btn.id = 'planProgramBtn';
      btn.textContent = '–°—ä–∑–¥–∞–π –ø—Ä–æ–≥—Ä–∞–º–∞';
      btn.style.margin = '1rem 0.5rem 1rem 0';
      main.insertBefore(btn, document.querySelector('.flex'));
    }
    if (!document.getElementById('programSelect')) {
      const sel = document.createElement('select');
      sel.id = 'programSelect';
      sel.style.margin = '1rem 0.5rem 1rem 0';
      sel.innerHTML = '<option value="">-- –ò–∑–±–µ—Ä–∏ –ø—Ä–æ–≥—Ä–∞–º–∞ --</option>';
      main.insertBefore(sel, document.querySelector('.flex'));
    }
  })();
  function getPrograms() {
    return JSON.parse(localStorage.getItem('programs')||'[]');
  }
  function savePrograms(arr) {
    localStorage.setItem('programs', JSON.stringify(arr));
  }
  function updateProgramSelect() {
    const sel = document.getElementById('programSelect');
    const arr = getPrograms();
    sel.innerHTML = '<option value="">-- –ò–∑–±–µ—Ä–∏ –ø—Ä–æ–≥—Ä–∞–º–∞ --</option>';
    arr.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = p.name;
      sel.appendChild(opt);
    });
  }
  document.getElementById('planProgramBtn').onclick = function() {
    const name = prompt('–ò–º–µ –Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–∞—Ç–∞:');
    if (!name) return;
    const days = prompt('–ë—Ä–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –≤ –ø—Ä–æ–≥—Ä–∞–º–∞—Ç–∞:');
    if (!days || isNaN(days)) return;
    const workouts = [];
    for (let i=1;i<=days;i++) {
      const type = prompt(`–í–∏–¥ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∑–∞ –¥–µ–Ω ${i}:`);
      const duration = prompt(`–ü—Ä–æ–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ—Å—Ç (–º–∏–Ω) –∑–∞ –¥–µ–Ω ${i}:`);
      workouts.push({id:generateId(), workout_type:type, duration_minutes:parseInt(duration,10), exercises:[]});
    }
    const arr = getPrograms();
    arr.push({id:generateId(), name, workouts});
    savePrograms(arr);
    updateProgramSelect();
    alert('–ü—Ä–æ–≥—Ä–∞–º–∞—Ç–∞ –µ —Å—ä–∑–¥–∞–¥–µ–Ω–∞!');
  };
  document.getElementById('programSelect').onchange = function() {
    const id = this.value;
    if (!id) return;
    const prog = getPrograms().find(p=>p.id==id);
    if (!prog) return;
    if (confirm('–î–∞ –¥–æ–±–∞–≤—è –≤—Å–∏—á–∫–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –æ—Ç —Ç–∞–∑–∏ –ø—Ä–æ–≥—Ä–∞–º–∞ –∫—ä–º –∫–∞–ª–µ–Ω–¥–∞—Ä–∞?')) {
      const workouts = getWorkouts();
      const today = new Date();
      prog.workouts.forEach((w,i) => {
        const d = new Date(today);
        d.setDate(today.getDate()+i);
        workouts.push({...w, id:generateId(), date:d.toISOString().slice(0,10), planned:true});
      });
      saveWorkouts(workouts);
      updateAll();
      alert('–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏—Ç–µ –æ—Ç –ø—Ä–æ–≥—Ä–∞–º–∞—Ç–∞ —Å–∞ –¥–æ–±–∞–≤–µ–Ω–∏!');
    }
  };
  updateProgramSelect();

  // --- –¢–∞–π–º–µ—Ä –∑–∞ –ø–æ—á–∏–≤–∫–∞ ---
  // –î–æ–±–∞–≤–∏ –≤ HTML: <button id="restTimerBtn">–¢–∞–π–º–µ—Ä –∑–∞ –ø–æ—á–∏–≤–∫–∞</button> <span id="restTimerDisplay"></span>
  (function insertRestTimerUI() {
    const main = document.querySelector('main');
    if (!document.getElementById('restTimerBtn')) {
      const btn = document.createElement('button');
      btn.id = 'restTimerBtn';
      btn.textContent = '–¢–∞–π–º–µ—Ä –∑–∞ –ø–æ—á–∏–≤–∫–∞';
      btn.style.margin = '1rem 0.5rem 1rem 0';
      main.insertBefore(btn, document.querySelector('.flex'));
      const span = document.createElement('span');
      span.id = 'restTimerDisplay';
      span.style.marginLeft = '1rem';
      main.insertBefore(span, document.querySelector('.flex'));
    }
  })();
  let restTimer = null, restTimeLeft = 0;
  document.getElementById('restTimerBtn').onclick = function() {
    if (restTimer) {
      clearInterval(restTimer);
      restTimer = null;
      document.getElementById('restTimerDisplay').textContent = '';
      return;
    }
    let min = prompt('–ú–∏–Ω—É—Ç–∏ –∑–∞ –ø–æ—á–∏–≤–∫–∞:', '1');
    if (!min || isNaN(min)) return;
    restTimeLeft = parseInt(min,10)*60;
    document.getElementById('restTimerDisplay').textContent = formatRestTime(restTimeLeft);
    restTimer = setInterval(()=>{
      restTimeLeft--;
      document.getElementById('restTimerDisplay').textContent = formatRestTime(restTimeLeft);
      if (restTimeLeft<=0) {
        clearInterval(restTimer);
        restTimer = null;
        document.getElementById('restTimerDisplay').textContent = '';
        // –ó–≤—É–∫
        const audio = new Audio('https://cdn.pixabay.com/audio/2022/07/26/audio_124bfa4c8b.mp3');
        audio.play();
        alert('–í—Ä–µ–º–µ—Ç–æ –∑–∞ –ø–æ—á–∏–≤–∫–∞ –∏–∑—Ç–µ—á–µ!');
      }
    },1000);
  };
  function formatRestTime(sec) {
    const m = Math.floor(sec/60), s = sec%60;
    return `${m}:${s.toString().padStart(2,'0')}`;
  }

  // --- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ñ–∏—Ç–Ω–µ—Å —É—Ä–µ–¥–∏ –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–∏–º–ø–æ—Ä—Ç –Ω–∞ JSON) ---
  // –î–æ–±–∞–≤–∏ –≤ HTML: <input type="file" id="deviceImport" accept=".json" style="display:none;" /> <button id="deviceImportBtn">–ò–º–ø–æ—Ä—Ç–∏—Ä–∞–π –æ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</button>
  (function insertDeviceImportUI() {
    const main = document.querySelector('main');
    if (!document.getElementById('deviceImportBtn')) {
      const btn = document.createElement('button');
      btn.id = 'deviceImportBtn';
      btn.textContent = '–ò–º–ø–æ—Ä—Ç–∏—Ä–∞–π –æ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ';
      btn.style.margin = '1rem 0.5rem 1rem 0';
      main.insertBefore(btn, document.querySelector('.flex'));
      const inp = document.createElement('input');
      inp.type = 'file';
      inp.id = 'deviceImport';
      inp.accept = '.json';
      inp.style.display = 'none';
      main.insertBefore(inp, document.querySelector('.flex'));
    }
  })();
  document.getElementById('deviceImportBtn').onclick = function() {
    document.getElementById('deviceImport').click();
  };
  document.getElementById('deviceImport').onchange = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = evt => {
      try {
        // –û—á–∞–∫–≤–∞ —Å–µ JSON —Å –º–∞—Å–∏–≤ –æ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
        const arr = JSON.parse(evt.target.result);
        if (Array.isArray(arr)) {
          const workouts = getWorkouts();
          arr.forEach(w => workouts.push({...w, id:generateId()}));
          saveWorkouts(workouts);
          updateAll();
          alert('–î–∞–Ω–Ω–∏—Ç–µ –æ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ—Ç–æ —Å–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä–∞–Ω–∏!');
        }
      } catch {}
    };
    reader.readAsText(file);
  };

  // --- –ò–∑–≤–µ—Å—Ç–∏—è –∏ –Ω–∞–ø–æ–º–Ω—è–Ω–∏—è (Notification API) ---
  if ('Notification' in window && Notification.permission !== 'granted') {
    Notification.requestPermission();
  }
  function notifyUser(msg) {
    if ('Notification' in window && Notification.permission === 'granted') {
      new Notification(msg);
    }
  }
  setInterval(() => {
    const workouts = getWorkouts();
    const today = new Date().toISOString().slice(0,10);
    workouts.forEach(w => {
      if (w.planned && w.date === today && !w.notified) {
        notifyUser('–î–Ω–µ—Å –∏–º–∞—Ç–µ –ø–ª–∞–Ω–∏—Ä–∞–Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞: ' + w.workout_type);
        w.notified = true;
        saveWorkouts(workouts);
      }
    });
  }, 60000);

  // --- –°–æ—Ü–∏–∞–ª–Ω–∏ —Ñ—É–Ω–∫—Ü–∏–∏ (—Å–ø–æ–¥–µ–ª—è–Ω–µ) ---
  // –î–æ–±–∞–≤–∏ –≤ HTML: <button id="shareBtn">–°–ø–æ–¥–µ–ª–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç</button>
  (function insertShareBtn() {
    const main = document.querySelector('main');
    if (!document.getElementById('shareBtn')) {
      const btn = document.createElement('button');
      btn.id = 'shareBtn';
      btn.textContent = '–°–ø–æ–¥–µ–ª–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç';
      btn.style.margin = '1rem 0.5rem 1rem 0';
      main.insertBefore(btn, document.querySelector('.flex'));
    }
  })();
  document.getElementById('shareBtn').onclick = function() {
    const workouts = getWorkouts();
    const text = '–ú–æ–∏—Ç–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:\n' + workouts.map(w=>`${w.date}: ${w.workout_type} (${w.duration_minutes} –º–∏–Ω)`).join('\n');
    if (navigator.share) {
      navigator.share({title:'–ú–æ–∏—Ç–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏', text});
    } else {
      prompt('–ö–æ–ø–∏—Ä–∞–π –∏ —Å–ø–æ–¥–µ–ª–∏:', text);
    }
  };

  // --- –õ–æ–≥ –∑–∞ —Ç–µ–≥–ª–æ –∏ –º–µ—Ä–∫–∏ ---
  // –î–æ–±–∞–≤–∏ –≤ HTML: <button id="weightLogBtn">–î–æ–±–∞–≤–∏ —Ç–µ–≥–ª–æ/–º–µ—Ä–∫–∏</button>
  (function insertWeightLogBtn() {
    const main = document.querySelector('main');
    if (!document.getElementById('weightLogBtn')) {
      const btn = document.createElement('button');
      btn.id = 'weightLogBtn';
      btn.textContent = '–î–æ–±–∞–≤–∏ —Ç–µ–≥–ª–æ/–º–µ—Ä–∫–∏';
      btn.style.margin = '1rem 0.5rem 1rem 0';
      main.insertBefore(btn, document.querySelector('.flex'));
    }
  })();
  function getWeightLog() {
    return JSON.parse(localStorage.getItem('weightLog')||'[]');
  }
  function saveWeightLog(arr) {
    localStorage.setItem('weightLog', JSON.stringify(arr));
  }
  document.getElementById('weightLogBtn').onclick = function() {
    const date = prompt('–î–∞—Ç–∞ (YYYY-MM-DD):', new Date().toISOString().slice(0,10));
    if (!date) return;
    const weight = prompt('–¢–µ–≥–ª–æ (–∫–≥):');
    const waist = prompt('–û–±–∏–∫–æ–ª–∫–∞ —Ç–∞–ª–∏—è (—Å–º):');
    const fat = prompt('–ü—Ä–æ—Ü–µ–Ω—Ç –º–∞–∑–Ω–∏–Ω–∏ (%):');
    const arr = getWeightLog();
    arr.push({date, weight, waist, fat});
    saveWeightLog(arr);
    alert('–î–∞–Ω–Ω–∏—Ç–µ —Å–∞ –∑–∞–ø–∏—Å–∞–Ω–∏!');
  };

  // --- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏ –ø—Ä–µ–ø–æ—Ä—ä–∫–∏ (basic) ---
  // –î–æ–±–∞–≤–∏ –≤ HTML: <button id="suggestBtn">–ü—Ä–µ–ø–æ—Ä—ä—á–∞–π —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>
  (function insertSuggestBtn() {
    const main = document.querySelector('main');
    if (!document.getElementById('suggestBtn')) {
      const btn = document.createElement('button');
      btn.id = 'suggestBtn';
      btn.textContent = '–ü—Ä–µ–ø–æ—Ä—ä—á–∞–π —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ';
      btn.style.margin = '1rem 0.5rem 1rem 0';
      main.insertBefore(btn, document.querySelector('.flex'));
    }
  })();
  document.getElementById('suggestBtn').onclick = function() {
    const workouts = getWorkouts();
    const freq = {};
    workouts.forEach(w => (w.exercises||[]).forEach(ex => freq[ex.name]=(freq[ex.name]||0)+1));
    const all = ['–ö–ª–µ–∫–æ–≤–µ','–õ–∏—Ü–µ–≤–∏ –æ–ø–æ—Ä–∏','–ë—è–≥–∞–Ω–µ','–ú—ä—Ä—Ç–≤–∞ —Ç—è–≥–∞','–ü–ª–∞–Ω–∫','–ö–æ—Ä–µ–º–Ω–∏ –ø—Ä–µ—Å–∏','–ë—ä—Ä–ø–∏—Ç–∞','–ö–æ–ª–æ–µ–∑–¥–µ–Ω–µ','–ô–æ–≥–∞'];
    const least = all.filter(n=>!freq[n]).concat(Object.entries(freq).sort((a,b)=>a[1]-b[1]).map(e=>e[0]));
    alert('–û–ø–∏—Ç–∞–π —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ: ' + (least[0]||'–ö–ª–µ–∫–æ–≤–µ'));
  };

  // --- –†–∞–Ω–∫–∏–Ω–≥ –∏ –ø–æ—Å—Ç–∏–∂–µ–Ω–∏—è (basic) ---
  // –î–æ–±–∞–≤–∏ –≤ HTML: <button id="achievementsBtn">–ü–æ—Å—Ç–∏–∂–µ–Ω–∏—è</button>
  (function insertAchievementsBtn() {
    const main = document.querySelector('main');
    if (!document.getElementById('achievementsBtn')) {
      const btn = document.createElement('button');
      btn.id = 'achievementsBtn';
      btn.textContent = '–ü–æ—Å—Ç–∏–∂–µ–Ω–∏—è';
      btn.style.margin = '1rem 0.5rem 1rem 0';
      main.insertBefore(btn, document.querySelector('.flex'));
    }
  })();
  document.getElementById('achievementsBtn').onclick = function() {
    const workouts = getWorkouts();
    const total = workouts.length;
    const maxDur = Math.max(...workouts.map(w=>w.duration_minutes),0);
    const msg = [
      total>=10 ? 'üèÖ 10 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏!' : '',
      maxDur>=120 ? 'üèÜ 2 —á–∞—Å–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞!' : '',
      workouts.some(w=>w.exercises && w.exercises.length>=5) ? 'ü•á 5+ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞!' : ''
    ].filter(Boolean).join('\n') || '–í—Å–µ –æ—â–µ –Ω—è–º–∞ –ø–æ—Å—Ç–∏–∂–µ–Ω–∏—è.';
    alert(msg);
  };

  // --- –ì–ª–∞—Å–æ–≤–∏ –∫–æ–º–∞–Ω–¥–∏ (Web Speech API, basic) ---
  // –î–æ–±–∞–≤–∏ –≤ HTML: <button id="voiceBtn">–ì–ª–∞—Å–æ–≤–æ –≤—ä–≤–µ–∂–¥–∞–Ω–µ</button>
  (function insertVoiceBtn() {
    const main = document.querySelector('main');
    if (!document.getElementById('voiceBtn')) {
      const btn = document.createElement('button');
      btn.id = 'voiceBtn';
      btn.textContent = '–ì–ª–∞—Å–æ–≤–æ –≤—ä–≤–µ–∂–¥–∞–Ω–µ';
      btn.style.margin = '1rem 0.5rem 1rem 0';
      main.insertBefore(btn, document.querySelector('.flex'));
    }
  })();
  document.getElementById('voiceBtn').onclick = function() {
    if (!('webkitSpeechRecognition' in window)) {
      alert('–ì–ª–∞—Å–æ–≤–æ—Ç–æ –≤—ä–≤–µ–∂–¥–∞–Ω–µ –Ω–µ —Å–µ –ø–æ–¥–¥—ä—Ä–∂–∞.');
      return;
    }
    const rec = new webkitSpeechRecognition();
    rec.lang = 'bg-BG';
    rec.onresult = function(e) {
      const txt = e.results[0][0].transcript;
      // –ü—Ä–∏–º–µ—Ä: "–î–æ–±–∞–≤–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –±—è–≥–∞–Ω–µ 30 –º–∏–Ω—É—Ç–∏"
      if (/–¥–æ–±–∞–≤–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞/i.test(txt)) {
        const m = txt.match(/—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞\s+(\w+)\s+(\d+)\s*–º–∏–Ω/i);
        if (m) {
          const workouts = getWorkouts();
          workouts.push({id:generateId(), date:new Date().toISOString().slice(0,10), workout_type:m[1], duration_minutes:parseInt(m[2],10), exercises:[]});
          saveWorkouts(workouts);
          updateAll();
          alert('–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ç–∞ –µ –¥–æ–±–∞–≤–µ–Ω–∞ —á—Ä–µ–∑ –≥–ª–∞—Å!');
        }
      }
    };
    rec.start();
  };

  // --- –ò–∑–±–æ—Ä –Ω–∞ –µ–∑–∏–∫ –∏ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è (basic) ---
  // –î–æ–±–∞–≤–∏ –≤ HTML: <select id="langSelect"><option value="bg">–ë—ä–ª–≥–∞—Ä—Å–∫–∏</option><option value="en">English</option></select>
  (function insertLangSelect() {
    const main = document.querySelector('main');
    if (!document.getElementById('langSelect')) {
      const sel = document.createElement('select');
      sel.id = 'langSelect';
      sel.innerHTML = '<option value="bg">–ë—ä–ª–≥–∞—Ä—Å–∫–∏</option><option value="en">English</option>';
      sel.style.margin = '1rem 0.5rem 1rem 0';
      main.insertBefore(sel, document.querySelector('.flex'));
    }
  })();
  document.getElementById('langSelect').onchange = function() {
    localStorage.setItem('lang', this.value);
    location.reload();
  };
  // –ü—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ, –∞–∫–æ –∏–º–∞ –µ–∑–∏–∫, —Å–º–µ–Ω–∏
  (function setLang() {
    const lang = localStorage.getItem('lang');
    if (lang && lang !== 'bg') {
      document.documentElement.lang = lang;
      // –ü—Ä–∏–º–µ—Ä–µ–Ω –ø—Ä–µ–≤–æ–¥ —Å–∞–º–æ –Ω–∞ –∑–∞–≥–ª–∞–≤–∏–µ—Ç–æ
      document.querySelector('nav').textContent = lang==='en'?'Fitness Tracker':'Fitness Tracker';
      document.querySelector('h1').textContent = lang==='en'?'Fitness Tracker':'Fitness Tracker';
    }
  })();

  // --- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ –∫–æ–ø–∏–µ (download) ---
  setInterval(() => {
    const data = localStorage.getItem('workouts');
    if (data) {
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      localStorage.setItem('workouts_backup_url', url);
    }
  }, 5*60*1000);

  // --- –ü–æ–¥–¥—Ä—ä–∂–∫–∞ –Ω–∞ —Ä–∞–∑–ª–∏—á–Ω–∏ –≤–∏–¥–æ–≤–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è (–ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è) ---
  // –ü—Ä–∏ –¥–æ–±–∞–≤—è–Ω–µ –Ω–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ, –∞–∫–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ç–∞ –µ "–∫–∞—Ä–¥–∏–æ", "—Å–∏–ª–∞" –∏ —Ç.–Ω., –º–æ–∂–µ –¥–∞ —Å–µ –¥–æ–±–∞–≤—è—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∏ –ø–æ–ª–µ—Ç–∞.
  // --- –°–ª–µ–¥–µ–Ω–µ –Ω–∞ —Å—ä–Ω ---
  // –î–æ–±–∞–≤–∏ –≤ HTML: <button id="sleepLogBtn">–î–æ–±–∞–≤–∏ —Å—ä–Ω</button>
  (function insertSleepLogBtn() {
    const main = document.querySelector('main');
    if (!document.getElementById('sleepLogBtn')) {
      const btn = document.createElement('button');
      btn.id = 'sleepLogBtn';
      btn.textContent = '–î–æ–±–∞–≤–∏ —Å—ä–Ω';
      btn.style.margin = '1rem 0.5rem 1rem 0';
      main.insertBefore(btn, document.querySelector('.flex'));
    }
  })();
  function getSleepLog() {
    return JSON.parse(localStorage.getItem('sleepLog')||'[]');
  }
  function saveSleepLog(arr) {
    localStorage.setItem('sleepLog', JSON.stringify(arr));
  }
  document.getElementById('sleepLogBtn').onclick = function() {
    const date = prompt('–î–∞—Ç–∞ (YYYY-MM-DD):', new Date().toISOString().slice(0,10));
    if (!date) return;
    const hours = prompt('–ß–∞—Å–æ–≤–µ —Å—ä–Ω:');
    const quality = prompt('–ö–∞—á–µ—Å—Ç–≤–æ (1-10):');
    const arr = getSleepLog();
    arr.push({date, hours:parseFloat(hours), quality:parseInt(quality,10)});
    saveSleepLog(arr);
    alert('–î–∞–Ω–Ω–∏—Ç–µ –∑–∞ —Å—ä–Ω—è —Å–∞ –∑–∞–ø–∏—Å–∞–Ω–∏!');
  };

  // --- –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞ –∫–∞—Ä—Ç–∞ –∑–∞ outdoor —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è (–±—è–≥–∞–Ω–µ –∏ –¥—Ä.) ---
  // –î–æ–±–∞–≤–∏ –≤ HTML: <div id="mapContainer" style="width:100%;height:300px;max-width:600px;margin:2rem auto;display:none;"></div>
  (function insertMapContainer() {
    const main = document.querySelector('main');
    if (!document.getElementById('mapContainer')) {
      const div = document.createElement('div');
      div.id = 'mapContainer';
      div.style.width = '100%';
      div.style.height = '300px';
      div.style.maxWidth = '600px';
      div.style.margin = '2rem auto';
      div.style.display = 'none';
      main.insertBefore(div, document.getElementById('workoutsListContainer'));
    }
  })();
  // –ü–æ–∫–∞–∑–≤–∞–π –∫–∞—Ä—Ç–∞, –∞–∫–æ –∏–º–∞ GPS –¥–∞–Ω–Ω–∏ –∫—ä–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ (–ø—Ä–∏–º–µ—Ä–Ω–æ –ø–æ–ª–µ w.route = [{lat, lng}, ...])
  function showMapForWorkout(route) {
    if (!window.L) {
      const script = document.createElement('script');
      script.src = 'https://unpkg.com/leaflet/dist/leaflet.js';
      script.onload = () => showMapForWorkout(route);
      document.head.appendChild(script);
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = 'https://unpkg.com/leaflet/dist/leaflet.css';
      document.head.appendChild(link);
      return;
    }
    const mapDiv = document.getElementById('mapContainer');
    mapDiv.style.display = 'block';
    mapDiv.innerHTML = '';
    const map = L.map(mapDiv).setView([route[0].lat, route[0].lng], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);
    const latlngs = route.map(p=>[p.lat,p.lng]);
    L.polyline(latlngs, {color:'blue'}).addTo(map);
    map.fitBounds(latlngs);
  }
  // –î–æ–±–∞–≤–∏ –±—É—Ç–æ–Ω "–ü–æ–∫–∞–∂–∏ –º–∞—Ä—à—Ä—É—Ç" –∫—ä–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å route
  const origLoadWorkouts = loadWorkouts;
  window.loadWorkouts = function() {
    origLoadWorkouts();
    const workouts = getWorkouts();
    setTimeout(()=>{
      document.querySelectorAll('.workout-card').forEach((card, idx) => {
        const w = workouts[idx];
        if (w && w.route && w.route.length) {
          let btn = card.querySelector('.btn-show-route');
          if (!btn) {
            btn = document.createElement('button');
            btn.textContent = '–ü–æ–∫–∞–∂–∏ –º–∞—Ä—à—Ä—É—Ç';
            btn.className = 'btn-show-route';
            btn.style.background = '#27ae60';
            btn.style.color = 'white';
            btn.style.marginLeft = '8px';
            btn.onclick = ()=>showMapForWorkout(w.route);
            card.querySelector('.workout-header').appendChild(btn);
          }
        }
      });
    }, 100);
  };

  // --- –í–∏–¥–µ–æ –∏–ª–∏ —Å–Ω–∏–º–∫–∏ –∫—ä–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è—Ç–∞ ---
  // –î–æ–±–∞–≤–∏ –ø–æ–ª–µ –≤—ä–≤ —Ñ–æ—Ä–º–∞—Ç–∞ –∑–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ:
  // <label for="exercise_media">–°–Ω–∏–º–∫–∞/–í–∏–¥–µ–æ:</label>
  // <input type="file" id="exercise_media" accept="image/*,video/*" />
  // –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–∞–π submit –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞:
  document.getElementById('exerciseForm').addEventListener('submit', async e => {
    e.preventDefault();
    const workoutId = parseInt(e.target.selectWorkout.value, 10);
    const exercise_name = e.target.exercise_name.value.trim();
    const reps = parseInt(e.target.reps.value, 10);
    const sets = parseInt(e.target.sets.value, 10);
    let media = '';
    if (e.target.exercise_media && e.target.exercise_media.files[0]) {
      media = await toBase64(e.target.exercise_media.files[0]);
    }
    if (!workoutId || !exercise_name || !reps || !sets || reps < 1 || sets < 1) {
      alert('–ú–æ–ª—è, –ø–æ–ø—ä–ª–Ω–µ—Ç–µ –≤—Å–∏—á–∫–∏ –ø–æ–ª–µ—Ç–∞ –ø—Ä–∞–≤–∏–ª–Ω–æ!');
      return;
    }
    const workouts = getWorkouts();
    const workout = workouts.find(w => w.id === workoutId);
    if (!workout) {
      alert('–ù–µ –µ –Ω–∞–º–µ—Ä–µ–Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å —Ç–æ–∑–∏ –∏–∑–±–æ—Ä!');
      return;
    }
    const newExercise = {
      id: generateId(),
      name: exercise_name,
      reps,
      sets,
      media
    };
    workout.exercises.push(newExercise);
    saveWorkouts(workouts);
    alert('–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ—Ç–æ –µ –¥–æ–±–∞–≤–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!');
    e.target.reset();
    updateAll();
  });
  // –ü–æ–∫–∞–∂–∏ –º–µ–¥–∏—è –∫—ä–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ
  const origLoadWorkouts2 = window.loadWorkouts;
  window.loadWorkouts = function() {
    origLoadWorkouts2();
    const workouts = getWorkouts();
    setTimeout(()=>{
      document.querySelectorAll('.workout-card').forEach((card, idx) => {
        const w = workouts[idx];
        if (w && w.exercises) {
          card.querySelectorAll('ul.exercises-list li').forEach((li, exIdx) => {
            const ex = w.exercises[exIdx];
            if (ex && ex.media) {
              let mediaEl;
              if (ex.media.startsWith('data:video')) {
                mediaEl = document.createElement('video');
                mediaEl.src = ex.media;
                mediaEl.controls = true;
                mediaEl.style.maxWidth = '100px';
                mediaEl.style.display = 'block';
              } else if (ex.media.startsWith('data:image')) {
                mediaEl = document.createElement('img');
                mediaEl.src = ex.media;
                mediaEl.style.maxWidth = '100px';
                mediaEl.style.display = 'block';
              }
              if (mediaEl) li.appendChild(mediaEl);
            }
          });
        }
      });
    }, 200);
  };

  // --- –ò—Å—Ç–æ—Ä–∏—è –Ω–∞ –ø–æ—Å—Ç–∏–∂–µ–Ω–∏—è (–ª–∏—á–Ω–∏ —Ä–µ–∫–æ—Ä–¥–∏) ---
  // –ó–∞–ø–∞–∑–∏ –Ω–∞–π-–¥–æ–±—Ä–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏ –≤ localStorage
  function getAchievementsHistory() {
    return JSON.parse(localStorage.getItem('achievementsHistory')||'[]');
  }
  function saveAchievementsHistory(arr) {
    localStorage.setItem('achievementsHistory', JSON.stringify(arr));
  }
  // –ü—Ä–∏ –¥–æ–±–∞–≤—è–Ω–µ –Ω–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ, –∞–∫–æ –µ –Ω–æ–≤ —Ä–µ–∫–æ—Ä–¥, –∑–∞–ø–∏—à–∏
  function updateAchievements(ex) {
    const arr = getAchievementsHistory();
    const prev = arr.find(a=>a.name===ex.name);
    const total = ex.reps*ex.sets;
    if (!prev || total > prev.total) {
      const rec = {name:ex.name, total, date:new Date().toISOString().slice(0,10)};
      if (prev) Object.assign(prev, rec);
      else arr.push(rec);
      saveAchievementsHistory(arr);
    }
  }
  // –î–æ–±–∞–≤–∏ –∫—ä–º exercise submit:
  const origExerciseSubmit = document.getElementById('exerciseForm').onsubmit;
  document.getElementById('exerciseForm').onsubmit = async function(e) {
    if (origExerciseSubmit) await origExerciseSubmit(e);
    // –ü–æ—Å–ª–µ–¥–Ω–æ—Ç–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ
    const workouts = getWorkouts();
    const last = workouts[workouts.length-1];
    if (last && last.exercises && last.exercises.length) {
      updateAchievements(last.exercises[last.exercises.length-1]);
    }
  };
  // –ü–æ–∫–∞–∂–∏ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞ –Ω–∞ –ø–æ—Å—Ç–∏–∂–µ–Ω–∏—è—Ç–∞
  (function insertAchievementsHistoryBtn() {
    const main = document.querySelector('main');
    if (!document.getElementById('achievementsHistoryBtn')) {
      const btn = document.createElement('button');
      btn.id = 'achievementsHistoryBtn';
      btn.textContent = '–ò—Å—Ç–æ—Ä–∏—è –Ω–∞ —Ä–µ–∫–æ—Ä–¥–∏';
      btn.style.margin = '1rem 0.5rem 1rem 0';
      main.insertBefore(btn, document.querySelector('.flex'));
    }
  })();
  document.getElementById('achievementsHistoryBtn').onclick = function() {
    const arr = getAchievementsHistory();
    if (!arr.length) return alert('–í—Å–µ –æ—â–µ –Ω—è–º–∞ —Ä–µ–∫–æ—Ä–¥–∏.');
    alert(arr.map(a=>`${a.name}: ${a.total} (${a.date})`).join('\n'));
  };

  // --- –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–∞–Ω–µ –Ω–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (—Ü–≤–µ—Ç–æ–≤–µ, —à—Ä–∏—Ñ—Ç–æ–≤–µ, –ø–æ–¥—Ä–µ–¥–±–∞) ---
  // –î–æ–±–∞–≤–∏ –≤ HTML: <button id="customizeBtn">–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–∞–π</button>
  (function insertCustomizeBtn() {
    const main = document.querySelector('main');
    if (!document.getElementById('customizeBtn')) {
      const btn = document.createElement('button');
      btn.id = 'customizeBtn';
      btn.textContent = '–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–∞–π';
      btn.style.margin = '1rem 0.5rem 1rem 0';
      main.insertBefore(btn, document.querySelector('.flex'));
    }
  })();
  document.getElementById('customizeBtn').onclick = function() {
    const color = prompt('–û—Å–Ω–æ–≤–µ–Ω —Ü–≤—è—Ç (hex):', localStorage.getItem('mainColor')||'#74ebd5');
    const font = prompt('–®—Ä–∏—Ñ—Ç (CSS font-family):', localStorage.getItem('mainFont')||'Poppins, sans-serif');
    if (color) {
      document.body.style.setProperty('--main-color', color);
      localStorage.setItem('mainColor', color);
      document.body.style.background = `linear-gradient(135deg, ${color} 0%, #ACB6E5 100%)`;
    }
    if (font) {
      document.body.style.fontFamily = font;
      localStorage.setItem('mainFont', font);
    }
    alert('–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ä—Ç –µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–∞–Ω!');
  };
  // –ü—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ, –ø—Ä–∏–ª–æ–∂–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è—Ç–∞
  (function applyCustomization() {
    const color = localStorage.getItem('mainColor');
    const font = localStorage.getItem('mainFont');
    if (color) document.body.style.background = `linear-gradient(135deg, ${color} 0%, #ACB6E5 100%)`;
    if (font) document.body.style.fontFamily = font;
  })();

  // (–¢–æ–≤–∞ –µ –ø—Ä–∏–º–µ—Ä, –∑–∞ –ø–æ-–¥–µ—Ç–∞–π–ª–Ω–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —â–µ —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–µ —Ä–∞–∑—à–∏—Ä–∏ —Ñ–æ—Ä–º–∞—Ç–∞ –∏ –ª–æ–≥–∏–∫–∞—Ç–∞.)
</script>
</body>
</html>
